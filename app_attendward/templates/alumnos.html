<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de cursos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="{{url_for('static',filename='/css/styles.css')}}">
    <link rel="stylesheet" href="{{url_for('static',filename='/css/lista_alumnos.css')}}">
</head>

<body class="body">
    <header class="header">
        <ul>
            <form method="GET" action="/cursos">
                <input class="btn btn-primary float-end text-center" type="submit" value="Atr√°s">
            </form>
            <li><img src="{{url_for('static',filename='/img/logoColor_banner.png')}}" alt="Logo UTEM"></li>
            <li>
                <h1 class="h1">Asistencia:</h1>
                <h2 class="h2">{{ seccion.nombre_asignatura }} - Secci√≥n {{ seccion.seccion }}</h2>
            </li>
            <li>
                <form action="/logout" method="post">
                    <button type="submit" class="btn btn-secondary">Cerrar sesi√≥n</button>
                </form>
            </li>
        </ul>
    </header>
    <div class="text-center">
        <h2>{{ fecha_actual.day }} de {{ meses[fecha_actual.month] }} de {{ fecha_actual.year }}</h2>
    </div>
    <main class="row">
        <!-- Aqu√≠ colocamos el bloque para manejar los mensajes flash -->
        <div class="container">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}
        </div>
        <button id="btn" class="btn btn-primary">Generar documento</button>
        <div class="col-sm">
            <div class="info">
                <h4>Agregar asistencia manualmente:</h4>
            </div>
            <div class="info">
                <div class="row">
                    <div class="col-md-9">
                        <input type="text" class="form-control" id="rutInput" placeholder="Rut: 12345678"
                            maxlength="8">
                    </div>
                    <div class="col-md-3">
                        <button id="agregarAsistenciaBtn" class="btn btn-success btn-block">Agregar</button>
                    </div>
                </div>
            </div>
            <div class="video-container">
                <img id="video" class="img-fluid" src="{{ url_for('video_feed') }}" alt="Video en directo">
            </div>


            <div class="info">
                <img src="{{url_for('static',filename='/img/exclamationCircle.png')}}" alt="Informaci√≥n">
                <p>Para agregar a un alumno no registrado en la lista, por favor contacte a un administrador.</p>
            </div>
        </div>
        <div class="col-sm div-listado" style="overflow-y: auto; height:500px">
            <table id="tabla-alumnos" >
                <caption></caption>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>RUT</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alumno in alumnos %}
                    <tr style="background-color: white;">
                        <td>{{ alumno.nombre }}</td>
                        <td>{{ alumno.apellido }}</td>
                        <td class="rut-cell">{{ alumno.rut }}</td>
                        <td>
                            <button id="quitarAsistenciaBtn{{ loop.index }}" type="button" class="btn btn-sm quitar-asistencia-btn">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>


    </main>
</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Agrega un escuchador de eventos para el clic del bot√≥n "Agregar"
        document.getElementById("agregarAsistenciaBtn").addEventListener("click", function (event) {
            // Evita que el formulario se env√≠e normalmente
            event.preventDefault();

            // Obtiene el valor ingresado en el campo de entrada
            const rutInput = document.getElementById("rutInput").value.trim();

            // Verifica si el valor no est√° vac√≠o
            if (rutInput !== "") {
                // Env√≠a el valor al servidor a trav√©s de una solicitud AJAX
                fetch('/agregar_manualmente', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rut: rutInput })
                })
                    .then(response => {
                        if (response.ok) {
                            // La operaci√≥n se realiz√≥ correctamente, actualiza la tabla si es necesario
                            updateTable();
                        } else {
                            console.error('Error al agregar manualmente el valor.');
                        }
                    })
                    .catch(error => console.error('Error al enviar la solicitud:', error));

                // Borra el campo de entrada despu√©s de agregar el valor
                document.getElementById("rutInput").value = "";
            } else {
                alert("Por favor ingresa un valor v√°lido antes de agregarlo.");
            }
        });
    });

    const quitarAsistenciaBtns = document.querySelectorAll('.quitar-asistencia-btn');
    quitarAsistenciaBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Obtener el rut del alumno correspondiente
            const rutAlumno = btn.parentNode.parentNode.querySelector('.rut-cell').textContent.trim();
            console.log(rutAlumno);
            // Realizar la solicitud AJAX al servidor Flask
            fetch('/quitar_asistencia', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ rut_estudiante: rutAlumno })
            })
            .then(response => {
                if (response.ok) {
                    // La operaci√≥n se realiz√≥ correctamente, actualiza la tabla si es necesario
                    updateTable();
                } else {
                    console.error('Error al quitar la asistencia.');
                }
            })
            .catch(error => console.error('Error al enviar la solicitud:', error));
        });
    });

    // Funci√≥n para actualizar la tabla con los ruts recibidos del backend
    function updateTable() {
        // Realiza una solicitud al endpoint /listaDetectados
        fetch('/listaDetectados')
            .then(response => response.json())
            .then(data => {
                // Obtiene los ruts del arreglo recibido del backend
                const ruts = data.arreglo;
                console.log(ruts); // Imprime la lista de ruts recibidos del backend
                if (ruts.length > 0) {
                    // Itera sobre los elementos de la tabla y cambia el color de los ruts coincidentes
                    const tableRows = document.querySelectorAll('#tabla-alumnos tr');

                    tableRows.forEach(row => {
                        const rutCell = row.querySelector('.rut-cell');
                        if (rutCell && ruts.includes(rutCell.textContent)) {
                            row.style.backgroundColor = 'yellow';
                        }else{
                            row.style.backgroundColor = 'white';
                        }
                    });
                }else{
                    const tableRows = document.querySelectorAll('#tabla-alumnos tr');
                    tableRows.forEach(row => {
                            row.style.backgroundColor = 'white';
                    });
                }
            })
            .catch(error => console.error('Error al actualizar la tabla:', error));
    }
    // Llama a la funci√≥n updateTable() cada segundo
    setInterval(updateTable, 1000);

</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Agrega un escuchador de eventos para el clic del bot√≥n "Generar documento"
        document.getElementById("btn").addEventListener("click", function (event) {
            // Evita que el formulario se env√≠e normalmente
            event.preventDefault();

            // Realiza una solicitud AJAX al servidor para generar el documento Excel
            fetch('/generar_documento_excel', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    // Descarga el archivo Excel generado
                    return response.blob();
                } else {
                    console.error('Error al generar el documento Excel.');
                }
            })
            .then(blob => {
                // Crea un enlace temporal para descargar el archivo
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'alumnos_detectados.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => console.error('Error al generar el documento Excel:', error));
        });
    });
</script>
</html>